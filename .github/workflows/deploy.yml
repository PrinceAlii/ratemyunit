name: Deploy

on:
  push:
    branches: ["main"]

permissions:
  id-token: write # Required for OIDC
  contents: read

env:
  AWS_REGION: ap-southeast-2
  # You must set these secrets in GitHub
  TF_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE }} 
  
jobs:
  infra:
    name: Terraform Apply
    runs-on: ubuntu-latest
    outputs:
      ecr_repository: ${{ steps.tf-out.outputs.ecr_repository_url }}
      s3_bucket: ${{ steps.tf-out.outputs.s3_bucket_name }}
      cloudfront_id: ${{ steps.tf-out.outputs.cloudfront_distribution_id }}
      # instance_id: ${{ steps.tf-out.outputs.instance_id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.10.0"

      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform

      - name: Get Terraform Outputs
        id: tf-out
        working-directory: terraform
        run: |
          echo "ecr_repository_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
          echo "s3_bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          
  deploy-backend:
    name: Deploy API (EC2)
    needs: infra
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ratemyunit-api # Hardcoded or passed from output
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Assuming Dockerfile is in apps/api
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f apps/api/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to EC2 via SSM
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=ratemyunit-api" \
            --parameters 'commands=["aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}", "docker pull ${{ steps.login-ecr.outputs.registry }}/ratemyunit-api:latest", "docker stop api || true", "docker rm api || true", "export DB_URL=$(aws ssm get-parameter --name /ratemyunit/production/database/url --with-decryption --query Parameter.Value --output text --region ap-southeast-2)", "export REDIS_URL=$(aws ssm get-parameter --name /ratemyunit/production/redis/url --with-decryption --query Parameter.Value --output text --region ap-southeast-2)", "export JWT_SECRET=$(aws ssm get-parameter --name /ratemyunit/production/jwt/secret --with-decryption --query Parameter.Value --output text --region ap-southeast-2)", "docker run -d --name api --network ratemyunit-net -p 80:3000 -e DATABASE_URL=$DB_URL -e REDIS_URL=$REDIS_URL -e JWT_SECRET=$JWT_SECRET ${{ steps.login-ecr.outputs.registry }}/ratemyunit-api:latest"]' \
            --comment "Deploying backend version ${{ github.sha }}"

  deploy-frontend:
    name: Deploy Web (S3+CF)
    needs: infra
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Web
        run: pnpm turbo build --filter=@ratemyunit/web

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3
        run: |
          # Need bucket name from infra output
          aws s3 sync apps/web/dist s3://${{ needs.infra.outputs.s3_bucket }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ needs.infra.outputs.cloudfront_id }} --paths "/*"
